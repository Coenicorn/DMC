const canvas=document.getElementById("GameScreen"),context=canvas.getContext("2d");let levelCache,levelContext,width,height,centerX,centerY;context.clear=function(){context.clearRect(0,0,width,height)};const imagePaths=["player_idle_left","player_idle_right","player_water","player_won","start","end","walk1","walk2","walk3","nowalk","spikes","spikes_death","cracked","broken_death","piranha","water1","water2","water_death","checkpoint","bridge_horizontal","bridge_vertical","fancy_arrow"],assets=[];let assetsLoaded=!1;function loadImages(){let e=imagePaths.length-1;function t(){if(!--e)try{assetsLoaded=!0}catch(t){throw t}}!function e(){for(let a=0;a<imagePaths.length;a++){let i=new Image,l=imagePaths[a];i.src="assets/"+l+".png",assets[l]=i,i.onload=t}}()}function Pic(e){return"walk"===e?assets[e+Math.round(2*Math.random()+1)]:"water"===e?assets[e+Math.round(Math.random()+1)]:assets[e]?assets[e]:void 0}function renderPlayer(){let[e,t]=getScreenCoordinates(player.x,player.y-.3),a="";"player_idle"==player.sprite&&(a="_left"),context.drawImage(Pic(player.sprite+a),e,t,imageSize*camera.zoom,imageSize*camera.zoom)}function updateTileSprite(e,t){let a=e.x*imageSize,i=e.y*imageSize;levelContext.clearRect(a,i,imageSize,imageSize),t&&t!==currentTheme+"_death"&&levelContext.drawImage(Pic(currentTheme),a,i,imageSize,imageSize),t?levelContext.drawImage(Pic(t),a,i,imageSize,imageSize):levelContext.drawImage(Pic(tiles[e.state]),a,i,imageSize,imageSize)}function render(){context.imageSmoothingEnabled=!1,context.clear();let[e,t]=getScreenCoordinates(0,0);context.drawImage(levelCache,e,t,levelCache.width*camera.zoom,levelCache.height*camera.zoom);let a=deathAmnt/10;context.globalAlpha=a<0?0:a/3,context.drawImage(pathCache,e,t,levelCache.width*camera.zoom,levelCache.height*camera.zoom),context.globalAlpha=1,renderPlayer(),[e,t]=getScreenCoordinates(player.x+.5,player.y+.5);let i=mouse.x-e,l=mouse.y-t,n=Math.atan2(centerX-mouse.x,centerY-mouse.y),r=Math.sqrt(Math.pow(Math.abs(i),2)+Math.pow(Math.abs(l),2));i=i/r*20,l=l/r*20,context.save(),context.translate(e+i,t+l),context.rotate(-n),context.translate(-(e+i),-(t+l)),context.globalAlpha=.7,context.drawImage(Pic("fancy_arrow"),e+i-imageSize/2,t+l-imageSize/2,imageSize,imageSize),context.globalAlpha=1,context.restore()}function getScreenCoordinates(e,t){let a=e-camera.x-1,i=t-camera.y-1;return[centerX+a*camera.zoom*imageSize,centerY+i*camera.zoom*imageSize]}let levelGrid,pathCache,imageSize=64,levelSize=10,currentTheme="water",deathTile=null,focussed=!0,running=!1,playerScore=0,animationTick=0,deathAmnt=0,startX,startY,player,camera,mouse={x:0,y:0};function getTilePos(e,t){return(levelGrid[Math.round(t)]||[])[Math.round(e)]||[]}function handleTile(e){let t,a;try{switch(tiles[e.state]){case"nowalk":t="nowalk",a=currentTheme+"_death";break;case"cracked":t="cracked",a="broken_death";break;case"spikes":t="spikes",a="spikes_death";break;case"end":t="won"}if(a&&updateTileSprite(e,a),!t)return;deathTile=e,player.kill(t),deathAmnt++,document.getElementById("controls").className="fadeIn"}catch(i){player.kill(currentTheme+"_death"),document.getElementById("controls").className="fadeIn",deathAmnt++}deathAmnt>10&&(deathAmnt=10)}function updateScore(){document.getElementById("score").innerHTML="Score: "+playerScore}function initNewLevel(){levelGrid=randomLevel(levelSize,levelSize);let e=findPath(levelGrid,1,1,levelSize-1,levelSize-1);pathCache=document.createElement("canvas");let t=pathCache.getContext("2d");pathCache.width=levelCache.width,pathCache.height=levelCache.height;for(let a=1,i=e.length;a<i;a++)t.strokeStyle="red",t.lineWidth=10,t.beginPath(),t.moveTo((e[a-1].x+.5)*imageSize,(e[a-1].y+.5)*imageSize),t.lineTo((e[a].x+.5)*imageSize,(e[a].y+.5)*imageSize),t.closePath(),t.stroke()}function nextLevel(){running=!1,levelSize+=2,playerScore++,updateScore(),player.speed+=speedIncrease,player.speed>maxSpeed&&(player.speed=maxSpeed),initNewLevel(),deathAmnt=0}function tick(e){let[t,a]=getScreenCoordinates(player.x+.5,player.y+.5),i=Math.sqrt(Math.pow(Math.abs(t=mouse.x-t),2)+Math.pow(Math.abs(a=mouse.y-a),2));t=t/i*player.speed*e,a=a/i*player.speed*e,player.x+=t,player.y+=a,handleTile(getTilePos(player.x,player.y))}let desired=60,fps=1e3/desired,last=Date.now();function loop(){let e=Date.now(),t=(e-last)/fps;last=e,++animationTick>=maxAnimationTick&&(animationTick=0),running&&tick(t),camera.follow(player.x-.5,player.y-.5),camera.update(),render(),requestAnimationFrame(loop)}function load(){onResize(),camera=new Camera,player=new Player,initNewLevel(),document.getElementById("loadingScreen").className="fadeOut",document.getElementById("gui").className="fadeIn",updateScore(),requestAnimationFrame(loop)}function onResize(){width=canvas.width=innerWidth,height=canvas.height=innerHeight,centerX=width/2,centerY=height/2}function animateLoad(){!player&&assetsLoaded&&load()}const controls={" "(){animateLoad(),player.movementTick||running||(document.getElementById("controls").className="fadeOut",camera.setZoom(2.2),running=!0)}};addEventListener("blur",()=>focussed=!1),addEventListener("focus",()=>focussed=!0),addEventListener("resize",onResize),addEventListener("mousemove",e=>{mouse.x=e.clientX,mouse.y=e.clientY}),addEventListener("keydown",e=>{controls[e.key]&&controls[e.key]()}),onload=loadImages;const deathTimer=2e3,maxAnimationTick=64;function Tile(e,t,a){this.x=e,this.y=t,this.state=a}const tiles=["cracked","spikes","nowalk","checkpoint","end","walk","start"],firstWalkableTile=3,speedIncrease=.003,maxSpeed=.08;class Camera{x;y;vX;vY;tX;tY;zoom;dZoom;speed;constructor(){this.x=this.y=this.vX=this.vY=this.tX=this.tY=0,this.zoom=1,this.dZoom=1,this.speed=1,this.maxSpeed=10}follow(e,t){this.tX=e,this.tY=t}updateVel(){let e=[this.tX-this.x,this.tY-this.y],t=Math.sqrt(Math.pow(Math.abs(e[0]),2)+Math.pow(Math.abs(e[1]),2));if(t<.01){this.vX=0,this.vY=0;return}let a=t*this.speed;t>this.maxSpeed&&(a=this.maxSpeed),e[0]=e[0]/t*a,e[1]=e[1]/t*a,this.vX=e[0],this.vY=e[1]}update(){this.updateVel();let e=(this.dZoom-this.zoom)/6;this.zoom+=e,this.x+=this.vX,this.y+=this.vY}setZoom(e){this.dZoom=e}}class Player{x;y;lX;lY;sprite;movementTick;speed;constructor(){this.x=this.y=0,this.lX=this.lY=0,this.sprite="player_idle",this.movementTick=0,this.speed=.02}kill(e){this.movementTick=1;let t=0;switch(e&&(t=2e3,camera.setZoom(3)),e){case"cracked":case"spikes":case"nowalk":this.sprite="nowalk";break;case"won":this.sprite="player_won",camera.setZoom(2)}running=!1,setTimeout(()=>{var t,a;t=e,a=this,a.x=startX,a.y=startY,a.x=a.x,a.y=a.y,a.sprite="player_idle",deathTile&&t&&updateTileSprite(deathTile),"won"==t&&nextLevel(),a.movementTick=0,camera.setZoom(2)},t)}}function findPath(e,t,a,i,l){let n=[],r=[],s=function(){let t=[];for(let a=0,i=e.length;a<i;a++)t.push([]);return t}();function o(t,a){return(e[a]||[])[t]||[]}function c(e,t,a,c){var h,m,d,g;let p=o(e+a,t+c);if(p===[]||r.includes(p)||p.state<3)return;let y=s[t][e].g+(0===a||0===c?1:1.41421356237),u=(h=p.x,m=p.y,d=i,g=l,Math.sqrt(Math.pow(d-h,2)+Math.pow(g-m,2)));n.includes(p)&&y>s[p.y][p.x].g||(s[p.y][p.x]={p:o(e,t),g:y,h:u,f:y+u},n.push(p))}for(s[a][t]={g:0,f:0,p:null},n.push(o(t,a));n.length>0;){let h=1/0,m,d;for(let g=0,p=n.length;g<p;g++)s[n[g].y][n[g].x].f<h&&(m=n[g],d=g,h=s[n[g].y][n[g].x].f);if(r.push(m),n.splice(d,1),m.x==i&&m.y==l)break;let y=m.x,u=m.y;c(y,u,-1,0),c(y,u,1,0),c(y,u,0,-1),c(y,u,0,1)}let x=e[l][i],f=[];for(;s[x.y][x.x].p;)f.push(x),x=s[x.y][x.x].p;return f}function randomLevel(e,t){let a=[];startX=1,startY=1;for(let i=0;i<t+1;i++){let l=[];for(let n=0;n<e+1;n++){let r=Math.floor(3*Math.random());l.push({x:n,y:i,state:r})}a.push(l)}return!function e(t){var i;t.state=tiles.indexOf("walk");let l,n,r,s,o,c=(l=(i=t).x,r=(a[(n=i.y)+2]||[])[l],s=(a[n]||[])[l+2],[r,s,o=(a[n-2]||[])[l],(a[n]||[])[l-2]]),h;for(;(void 0==(h=c[Math.floor(Math.random()*c.length)])||!(h.state<3))&&0!=c.length;)c.splice(c.indexOf(h),1);if(h){h.parent=t;let m=(t.x+h.x)/2;a[(t.y+h.y)/2][m].state=tiles.indexOf("walk")}t.parent&&!h&&(h=t.parent),h?e(h):function e(){let t,i;for(let l=0;l<a.length;l++)for(let n=0;n<a[l].length;n++){let r=a[l][n];if(r.state!=tiles.indexOf("walk"))continue;let s=Math.abs(r.x-startX)+Math.abs(r.y-startY);(!t||t<s)&&(t=s,i=r)}i.state=tiles.indexOf("end"),a[startX][startY].state=tiles.indexOf("start"),function e(){for(let t=0;t<a.length;t++)for(let i=0;i<a[t].length;i++){let l=new Tile(i,t,a[t][i].state);"start"===tiles[l.state]&&(startX=l.x,startY=l.y,checkX=startX,checkY=startY),a[t][i]=l}(function e(){levelContext=(levelCache=document.createElement("canvas")).getContext("2d"),levelCache.width=a[0].length*imageSize,levelCache.height=a.length*imageSize,levelContext.imageSmoothingEnabled=!1;for(let t=0;t<a.length;t++)for(let i=0;i<a[t].length;i++){let l=a[t][i];"nowalk"!==tiles[l.state]&&(levelContext.drawImage(Pic(currentTheme),l.x*imageSize,l.y*imageSize,imageSize,imageSize),levelContext.drawImage(Pic(tiles[l.state]),l.x*imageSize,l.y*imageSize,imageSize,imageSize),l.state>=3&&((a[t]||[])[i-1]&&(a[t]||[])[i-1].state>=3&&levelContext.drawImage(Pic("bridge_horizontal"),l.x*imageSize-imageSize/2,l.y*imageSize,imageSize,imageSize),(a[t-1]||[])[i]&&(a[t-1]||[])[i].state>=3&&levelContext.drawImage(Pic("bridge_vertical"),l.x*imageSize,l.y*imageSize-imageSize/2,imageSize,imageSize)))}if(void 0==startX||void 0==startY)throw Error("Level initialization error, no start tile defined");player.kill()})()}()}()}(a[startX][startY]),a}