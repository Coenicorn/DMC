function Tile(e,t,i){this.x=e,this.y=t,this.state=i}const tiles=["cracked","spikes","nowalk","checkpoint","end","walk","start"],firstWalkableTile=3;function randomLevel(e,t){let i=[];startX=1,startY=1;for(let a=0;a<t+1;a++){let l=[];for(let r=0;r<e+1;r++){let n=Math.floor(3*Math.random());l.push({x:r,y:a,state:n})}i.push(l)}return!function e(t){var a;t.state=tiles.indexOf("walk");let l,r,n,s,o,c=(l=(a=t).x,n=(i[(r=a.y)+2]||[])[l],s=(i[r]||[])[l+2],[n,s,o=(i[r-2]||[])[l],(i[r]||[])[l-2]]),d;for(;(void 0==(d=c[Math.floor(Math.random()*c.length)])||!(d.state<3))&&0!=c.length;)c.splice(c.indexOf(d),1);if(d){d.parent=t;let m=(t.x+d.x)/2;i[(t.y+d.y)/2][m].state=tiles.indexOf("walk")}t.parent&&!d&&(d=t.parent),d?e(d):function e(){let t,a;for(let l=0;l<i.length;l++)for(let r=0;r<i[l].length;r++){let n=i[l][r];if(n.state!=tiles.indexOf("walk"))continue;let s=Math.abs(n.x-startX)+Math.abs(n.y-startY);(!t||t<s)&&(t=s,a=n)}a.state=tiles.indexOf("end"),i[startX][startY].state=tiles.indexOf("start"),function e(){levelContext=(levelCache=document.createElement("canvas")).getContext("2d"),levelCache.width=i[0].length*tileSize,levelCache.height=i.length*tileSize,levelContext.imageSmoothingEnabled=!1;for(let t=0;t<i.length;t++)for(let a=0;a<i[t].length;a++){let l=new Tile(a,t,i[t][a].state);"start"===tiles[l.state]&&(startX=l.x,startY=l.y,checkX=startX,checkY=startY),i[t][a]=l,"nowalk"!==tiles[l.state]&&(levelContext.drawImage(Pic(currentTheme),l.x*tileSize,l.y*tileSize,tileSize,tileSize),levelContext.drawImage(Pic(tiles[l.state]),l.x*tileSize,l.y*tileSize,tileSize,tileSize),l.state>=3&&((i[t]||[])[a-1]&&(i[t]||[])[a-1].state>=3&&levelContext.drawImage(Pic("bridge_horizontal"),l.x*tileSize-tileSize/2,l.y*tileSize,tileSize,tileSize),(i[t-1]||[])[a]&&(i[t-1]||[])[a].state>=3&&levelContext.drawImage(Pic("bridge_vertical"),l.x*tileSize,l.y*tileSize-tileSize/2,tileSize,tileSize)))}if(void 0==startX||void 0==startY)throw Error("Level initialization error, no start tile defined");player.kill()}()}()}(i[startX][startY]),i}const canvas=document.getElementById("GameScreen"),context=canvas.getContext("2d");let levelCache,levelContext,width,height,centerX,centerY;context.clear=function(){context.clearRect(0,0,width,height)};const imagePaths=["player_idle_left","player_idle_right","player_water","player_won","start","end","walk1","walk2","walk3","nowalk","spikes","spikes_death","cracked","broken_death","piranha","water1","water2","water_death","checkpoint","bridge_horizontal","bridge_vertical","fancy_arrow"],assets=[];let assetsLoaded=!1;function loadImages(){let e=imagePaths.length-1;function t(){if(!--e)try{assetsLoaded=!0}catch(t){throw t}}!function e(){for(let i=0;i<imagePaths.length;i++){let a=new Image,l=imagePaths[i];a.src="assets/"+l+".png",assets[l]=a,a.onload=t}}()}function Pic(e){return"walk"===e?assets[e+Math.round(2*Math.random()+1)]:"water"===e?assets[e+Math.round(Math.random()+1)]:assets[e]?assets[e]:void 0}function renderPlayer(){let[e,t]=getScreenCoordinates(player.x,player.y-.3),i="";"player_idle"==player.sprite&&(i="_left"),context.drawImage(Pic(player.sprite+i),e,t,tileSize*camera.m_zoom,tileSize*camera.m_zoom)}function updateTileSprite(e,t){let i=e.x*tileSize,a=e.y*tileSize;levelContext.clearRect(i,a,tileSize,tileSize),t&&t!==currentTheme+"_death"&&levelContext.drawImage(Pic(currentTheme),i,a,tileSize,tileSize),t?levelContext.drawImage(Pic(t),i,a,tileSize,tileSize):levelContext.drawImage(Pic(tiles[e.state]),i,a,tileSize,tileSize)}function render(){context.imageSmoothingEnabled=!1,context.clear();let[e,t]=getScreenCoordinates(0,0);context.drawImage(levelCache,e,t,levelCache.width*camera.m_zoom,levelCache.height*camera.m_zoom),renderPlayer(),[e,t]=getScreenCoordinates(player.x+.5,player.y+.5);let i=mouse.x-e,a=mouse.y-t,l=Math.atan2(centerX-mouse.x,centerY-mouse.y),r=Math.sqrt(Math.pow(Math.abs(i),2)+Math.pow(Math.abs(a),2));i=i/r*20,a=a/r*20,context.save(),context.translate(e+i,t+a),context.rotate(-l),context.translate(-(e+i),-(t+a)),context.globalAlpha=.7,context.drawImage(Pic("fancy_arrow"),e+i-tileSize/2,t+a-tileSize/2,tileSize,tileSize),context.globalAlpha=1,context.restore()}function lerp(e,t,i,a,l){if(l<0||l>1)throw Error("t must be between 0 and 1 in lerp");return[e+(i-e)*l,t+(a-t)*l]}function getScreenCoordinates(e,t){let i=e-camera.x-1,a=t-camera.y-1;return[centerX+i*camera.m_zoom*tileSize,centerY+a*camera.m_zoom*tileSize]}let levelGrid,tileSize=64,levelSize=10;const deathTimer=2e3;let speedIncrease=.005,maxSpeed=.1,currentTheme="water",deathTile=null,focussed=!0,running=!1,playerScore=0,animationTick=0;const maxAnimationTick=64;let startX,startY,player,camera,mouse={x:0,y:0};class Camera{x;y;vX;vY;tX;tY;m_zoom;m_dZoom;m_speed;constructor(){this.x=this.y=this.vX=this.vY=this.tX=this.tY=0,this.m_zoom=1,this.m_dZoom=1,this.m_speed=1,this.m_maxSpeed=10}follow(e,t){this.tX=e,this.tY=t}updateVel(){let e=[this.tX-this.x,this.tY-this.y],t=Math.sqrt(Math.pow(Math.abs(e[0]),2)+Math.pow(Math.abs(e[1]),2));if(t<.01){this.vX=0,this.vY=0;return}let i=t*this.m_speed;t>this.maxSpeed&&(i=this.m_maxSpeed),e[0]=e[0]/t*i,e[1]=e[1]/t*i,this.vX=e[0],this.vY=e[1]}update(){this.updateVel();let e=(this.m_dZoom-this.m_zoom)/6;this.m_zoom+=e,this.x+=this.vX,this.y+=this.vY}zoom(e){this.m_dZoom=e}}class Player{x;y;lX;lY;direction;sprite;movementTick;speed;constructor(){this.x=this.y=0,this.lX=this.lY=0,this.direction=0,this.sprite="player_idle",this.movementTick=0,this.speed=.02}kill(e){this.movementTick=1;let t=0;switch(e&&(t=2e3,camera.zoom(3)),e){case"cracked":case"spikes":case"nowalk":this.sprite="nowalk";break;case"won":this.sprite="player_won",camera.zoom(2)}running=!1,setTimeout(()=>{var t,i;t=e,i=this,i.x=startX,i.y=startY,i.x=i.x,i.y=i.y,i.sprite="player_idle",deathTile&&t&&updateTileSprite(deathTile),"won"==t&&nextLevel(),i.movementTick=0,camera.zoom(2)},t)}}function getTilePos(e,t){return(levelGrid[Math.round(t)]||[])[Math.round(e)]||[]}function handleTile(e){let t,i;try{switch(tiles[e.state]){case"nowalk":t="nowalk",i=currentTheme+"_death";break;case"cracked":t="cracked",i="broken_death";break;case"spikes":t="spikes",i="spikes_death";break;case"end":t="won"}if(i&&updateTileSprite(e,i),!t)return;deathTile=e,player.kill(t)}catch(a){player.kill(currentTheme+"_death")}}function updateScore(){document.getElementById("score").innerHTML="Score: "+playerScore}function nextLevel(){running=!1,levelSize+=2,playerScore++,updateScore(),player.speed+=speedIncrease,player.speed>maxSpeed&&(player.speed=maxSpeed),levelGrid=randomLevel(levelSize,levelSize)}function tick(e){let[t,i]=getScreenCoordinates(player.x+.5,player.y+.5),a=Math.sqrt(Math.pow(Math.abs(t=mouse.x-t),2)+Math.pow(Math.abs(i=mouse.y-i),2));t=t/a*player.speed*e,i=i/a*player.speed*e,player.x+=t,player.y+=i,handleTile(getTilePos(player.x,player.y))}let desired=60,fps=1e3/desired,last=Date.now();function loop(){let e=Date.now(),t=(e-last)/fps;last=e,++animationTick>=64&&(animationTick=0),running&&tick(t),camera.follow(player.x-.5,player.y-.5),camera.update(),render(),requestAnimationFrame(loop)}function load(){onResize(),camera=new Camera,player=new Player,levelGrid=randomLevel(levelSize,levelSize),document.getElementById("howtoplay").style.visibility="visible",document.getElementById("loadingScreen").className="animation",updateScore(),requestAnimationFrame(loop)}function onResize(){width=canvas.width=innerWidth,height=canvas.height=innerHeight,centerX=width/2,centerY=height/2}addEventListener("blur",()=>focussed=!1),addEventListener("focus",()=>focussed=!0),addEventListener("resize",onResize),addEventListener("mousemove",e=>{mouse.x=e.clientX,mouse.y=e.clientY}),addEventListener("keydown",e=>{" "!=e.key||(document.getElementById("clicktoplay").click(),running||player.movementTick||(running=!0,camera.zoom(2.2)))}),onload=loadImages;